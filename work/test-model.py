import os
import argparse
import json
from time import time
from generate import LLM
from tqdm_loggable.auto import tqdm
from database import Database
from custom_dataset import CustomDataset
from torch.utils.data import DataLoader
from transformers import AutoModel, AutoTokenizer
from huggingface_hub import login
import logging
from dotenv import load_dotenv

load_dotenv()
MIN_BATCH_SIZE = 1

logging.basicConfig(
    level=logging.DEBUG, format="%(asctime)s - %(levelname)s - %(message)s"
)


parser = argparse.ArgumentParser(
    description="Run the main script with arguments.")
parser.add_argument("--model_name", type=str,
                    help="Name of the Hugging Face model")
parser.add_argument("--hf_token", type=str, help="Hugging Face token")

args = parser.parse_args()

model_name = args.model_name or os.getenv("MODEL_NAME")
tokenizer_name = model_name
HF_TOKEN = args.hf_token or os.getenv("HF_TOKEN")

login(token=HF_TOKEN)

test_prompt = "Below is an instruction that describes a task, paired with an input that provides further context. Write a response that\nappropriately completes the request. ### Instruction: This is an entity linking task. The goal for this task is to link the selected entity mention in the table\ncells to the entity in the knowledge base. You will be given a list of referent entities, with each one composed of an\nentity name, its description and its type. Please choose the correct one from the referent entity candidates. ### Input: [TLE] None. [TAB] col: | col0 | col1 |row 1: | 1 | Part Appropriation Act, 1990 | [SEP] row 2: | 2 | Additional Post Office Appropriation Act, 1990 | [SEP] row 3: | 3 | Public Accountants' and Auditors' Amendment Act, 1990 | [SEP] row 4: | 4 | Transport Services Additional Appropriation Act, 1990 | [SEP] row 5: | 5 | Alexander Bay Development Corporation Amendment Act, 1990 | [SEP] row 6: | 6 | Additional Appropriation Act, 1990 | [SEP] row 7: | 7 | Part Appropriation Act (House of Representatives), 1990 | [SEP] row 8: | 8 | Part Appropriation Act (House of Assembly), 1990 | [SEP] row 9: | 9 | Prevention and Combating of Pollution of the Sea by Oil Amendment Act, 1990 | [SEP] row 10: | 10 | Associated Health Service Professions Amendment Act, 1990 | [SEP] row 11: | 11 | Part Appropriation Act (House of Delegates), 1990 | [SEP] row 12: | 12 | Reciprocal Service of Civil Process Act, 1990 | [SEP] row 13: | 13 | Attorneys Amendment Act, 1990 | [SEP] row 14: | 14 | Small Claims Courts Amendment Act, 1990 | [SEP] row 15: | 15 | Trade Metrology Amendment Act, 1990 | [SEP] row 16: | 16 | Small Business Development Amendment Act, 1990 | [SEP] row 17: | 17 | Close Corporations Amendment Act, 1990 | [SEP] row 18: | 18 | Companies Amendment Act, 1990 | [SEP] row 19: | 19 | Additional Appropriation Act (House of Assembly), 1990 | [SEP] row 20: | 20 | Additional Appropriation Act (House of Representatives), 1990 | [SEP] row 21: | 21 | Additional Appropriation Act (House of Delegates), 1990 | [SEP] row 22: | 22 | Post Office Appropriation Act, 1990 | [SEP] row 23: | 23 | National Parks Amendment Act, 1990 | [SEP] row 24: | 24 | Radio Amendment Act, 1990 | [SEP] row 25: | 25 | Security Officers Amendment Act, 1990 | [SEP] row 26: | 26 | Remuneration of Town Clerks Amendment Act, 1990 | [SEP] row 27: | 27 | Maintenance of Surviving Spouses Act, 1990 | [SEP] row 28: | 28 | Stock Theft Amendment Act, 1990 | [SEP] row 29: | 29 | Dangerous Weapons Amendment Act, 1990 | [SEP] row 30: | 30 | Arms and Ammunition Amendment Act, 1990 | [SEP] row 31: | 31 | Development Trust and Land Second Amendment Act, 1990 | [SEP] row 32: | 32 | Municipal Ordinance Amendment Act (Cape) (House of Assembly), 1990 | [SEP] row 33: | 33 | Local Government Ordinance Amendment Act (O.F.S.) (House of Assembly), 1990 | [SEP] row 34: | 34 | Recognition of the Independence of Namibia Act, 1990 | [SEP] row 35: | 35 | Indemnity Act, 1990 | [SEP] row 36: | 36 | Rand Water Board Statutes (Private) Act Amendment Act, 1990 | [SEP] row 37: | 37 | Town and Regional Planners Amendment Act, 1990 | [SEP] row 38: | 38 | Roodepoort and Weltevreden Agricultural Settlements Adjustment Amendment Act, 1990 | [SEP] row 39: | 39 | Manpower Training Amendment Act, 1990 | [SEP] row 40: | 40 | Workmen's Compensation Amendment Act, 1990 | [SEP] row 41: | 41 | Universities and Technikons (Education and Training) Amendment Act, 1990 | [SEP] row 42: | 42 | Education and Training Amendment Act, 1990 | [SEP] row 43: | 43 | Harmful Business Practices Amendment Act, 1990 | [SEP] row 44: | 44 | Import and Export Control Amendment Act, 1990 | [SEP] row 45: | 45 | Inquests Amendment Act, 1990 | [SEP] row 46: | 46 | Natural Scientists' Amendment Act, 1990 | [SEP] row 47: | 47 | University of Stellenbosch (Private) Amendment Act (House of Assembly), 1990 | [SEP] row 48: | 48 | Validation of Certain By-Laws Act (House of Assembly), 1990 | [SEP] row 49: | 49 | Divisional Councils Ordinance Amendment Act (Cape) (House of Assembly), 1990 | [SEP] row 50: | 50 | Local Government (Administration and Elections) Ordinance Amendment Act (Transvaal) (House of Assembly), 1990 | [SEP] row 51: | 51 | Local Councils Amendment Act (House of Assembly), 1990 | [SEP] row 52: | 52 | Local Government Ordinance Amendment Act (Transvaal) (House of Assembly), 1990 | [SEP] row 53: | 53 | Local Authorities Rating Ordinance Amendment Act (Transvaal) (House of Assembly), 1990 | [SEP] row 54: | 54 | Local Authorities Capital Development Fund Ordinance Amendment Act (Transvaal) (House of Assembly), 1990 | [SEP] row 55: | 55 | Land Use Planning Ordinance Amendment Act (Cape) (House of Assembly), 1990 | [SEP] row 56: | 56 | Dog Tax Ordinance Amendment Act (Cape) (House of Assembly), 1990 | [SEP] row 57: | 57 | Appropriation Act (House of Assembly), 1990 | [SEP] row 58: | 58 | Appropriation Act (House of Delegates), 1990 | [SEP] row 59: | 59 | Customs and Excise Amendment Act, 1990 | [SEP] row 60: | 60 | Private Schools Amendment Act (House of Assembly), 1990 | [SEP] row 61: | 61 | Constitution Amendment Act, 1990 | [SEP] row 62: | 62 | Transnet Pension Fund Act, 1990 | [SEP] row 63: | 63 | Administration of Estates Amendment Act, 1990 | [SEP] row 64: | 64 | Financial Institutions Amendment Act, 1990 | [SEP] row 65: | 65 | Reinsurance of Material Damage and Losses Amendment Act, 1990 | [SEP] row 66: | 66 | Auditor-General Amendment Act, 1990 | [SEP] row 67: | 67 | Usury Amendment Act, 1990 | [SEP] row 68: | 68 | Water Amendment Act, 1990 | [SEP] row 69: | 69 | Companies Second Amendment Act, 1990 | [SEP] row 70: | 70 | Housing Development Schemes for Retired Persons Amendment Act, 1990 | [SEP] row 71: | 71 | Scientific Research Council Amendment Act, 1990 | [SEP] row 72: | 72 | Development Trust and Land Amendment Act, 1990 | [SEP] row 73: | 73 | Excision of Released Areas Amendment Act, 1990 | [SEP] row 74: | 74 | South African Citizenship at Attainment of Independence by Namibia Regulation Act, 1990 | [SEP] row 75: | 75 | Research Development Act, 1990 | [SEP] row 76: | 76 | Land Survey Amendment Act, 1990 | [SEP] row 77: | 77 | Urban Transport Amendment Act, 1990 | [SEP] row 78: | 78 | Abuse of Dependence-producing Substances and Rehabilitation Centres Amendment Act, 1990 | [SEP] row 79: | 79 | Medical, Dental and Supplementary Health Service Professions Amendment Act, 1990 | [SEP] row 80: | 80 | Prevention of Illegal Squatting Amendment Act, 1990 | [SEP] row 81: | 81 | Abolition of Development Bodies Amendment Act, 1990 | [SEP] row 82: | 82 | Civil Defence Amendment Act, 1990 | [SEP] row 83: | 83 | Fire Brigade Services Amendment Act, 1990 | [SEP] row 84: | 84 | KwaZulu and Natal Joint Services Act, 1990 | [SEP] row 85: | 85 | Livestock Improvement Amendment Act, 1990 | [SEP] row 86: | 86 | Agricultural Research Act, 1990 | [SEP] row 87: | 87 | Wine and Spirit Control Amendment Act, 1990 | [SEP] row 88: | 88 | Maintenance and Promotion of Competition Amendment Act, 1990 | [SEP] row 89: | 89 | Taxation Laws Amendment Act, 1990 | [SEP] row 90: | 90 | Mier Rural Area Act (House of Representatives), 1990 | [SEP] row 91: | 91 | Housing and Development Amendment Act (House of Representatives), 1990 | [SEP] row 92: | 92 | Prisons Amendment Act, 1990 | [SEP] row 93: | 93 | Appropriation Act, 1990 | [SEP] row 94: | 94 | Deposit-taking Institutions Act, 1990 (before 1993)    Banks Act, 1990 (after 1993) | [SEP] row 95: | 95 | Extension of the Powers of the South African Reserve Bank Act, 1990 | [SEP] row 96: | 96 | Mutual Building Societies Amendment Act, 1990 | [SEP] row 97: | 97 | Financial Services Board Act, 1990 | [SEP] row 98: | 98 | Sea Fishery Amendment Act, 1990 | [SEP] row 99: | 99 | Human Sciences Research Amendment Act, 1990 | [SEP] row 100: | 100 | Discriminatory Legislation regarding Public Amenities Repeal Act, 1990 | [SEP] row 101: | 101 | Income Tax Act, 1990 | [SEP] row 102: | 102 | Correspondence Colleges Amendment Act (House of Assembly), 1990 | [SEP] row 103: | 103 | Appropriation Act (House of Representatives), 1990 | [SEP] row 104: | 104 | Local Government Ordinance Second Amendment Act (Orange Free State) (House of Assembly), 1990 | [SEP] row 105: | 105 | Extension of the Public Resorts Ordinance Act (Transvaal) (House of Assembly), 1990 | [SEP] row 106: | 106 | University of Pretoria (Private) Act (House of Assembly), 1990 | [SEP] row 107: | 107 | Criminal Law Amendment Act, 1990 | [SEP] row 108: | 108 | Mentally Ill Persons' Legal Interests Amendment Act, 1990 | [SEP] row 109: | 109 | Finance Act, 1990 | [SEP] row 110: | 110 | Police Amendment Act, 1990 | [SEP] row 111: | 111 | National States Constitution Amendment Act, 1990 | [SEP] row 112: | 112 | Application of Certain Laws to Namibia Abolition Act, 1990 | [SEP] row 113: | 113 | Broadcasting Amendment Act, 1990 | [SEP] row 114: | 114 | Engineering Profession of South Africa Act, 1990 | [SEP] row 115: | 115 | Air Services Licensing Act, 1990 | [SEP] row 116: | 116 | National Policy for Health Act, 1990 | [SEP] row 117: | 117 | Pension Laws Amendment Act, 1990 | [SEP] row 118: | 118 | Pensions (Supplementary) Act, 1990 | [SEP] row 119: | 119 | Agricultural Product Standards Act, 1990 | [SEP] row 120: | 120 | Public Service Laws Amendment Act, 1990 | [SEP] row 121: | 121 | Rural Areas Amendment Act (House of Representatives), 1990 | ### Question: The selected entity mention in the table cell is: Higher Education Amendment Act, 2008. The column name for 'Higher Education Amendment Act, 2008' is col1. The referent entity candidates are: <Higher Education Funding Amendment Act 1994 [DESCRIPTION] Act of the Parliament of Australia [TYPE] Act of the Parliament of Australia>, <Supreme Court (Number of Judges) Amendment Act, 2008 [DESCRIPTION] Act of the Parliament of India [TYPE] Act of the Parliament of India>, <NIL [DESCRIPTION] Not in list [TYPE] None>, <Higher Education Funding Amendment Act 1992 [DESCRIPTION] Act of the Parliament of Australia [TYPE] Act of the Parliament of Australia>, <Higher Education Funding Amendment Act 1998 [DESCRIPTION] Act of the Parliament of Australia [TYPE] Act of the Parliament of Australia>, <Higher Education Funding Amendment Act 1991 [DESCRIPTION] Act of the Parliament of Australia [TYPE] Act of the Parliament of Australia>, <Higher Education Funding Amendment Act 1988 [DESCRIPTION] Act of the Parliament of Australia [TYPE] Act of the Parliament of Australia>, <Higher Education Funding Amendment Act 1989 [DESCRIPTION] Act of the Parliament of Australia [TYPE] Act of the Parliament of Australia>, <Finance Act, 2008 [DESCRIPTION] Act of the Oireachtas No. 3 of 2008 [TYPE] Act of the Oireachtas>, <Higher Education Support Amendment Act 2010 [DESCRIPTION] Act of the Parliament of Australia, currently registered as C2010A00006 [TYPE] Act of the Parliament of Australia>, <Higher Education Funding Amendment Act 2002 [DESCRIPTION] Act of the Parliament of Australia, currently registered as C2004A01024 [TYPE] Act of the Parliament of Australia>, <Higher Education Authority Act, 1971 [DESCRIPTION] Act of the Oireachtas No. 22 of 1971 [TYPE] Act of the Oireachtas>, <Higher Education Support Amendment (VET FEE-HELP Assistance) Act 2008 [DESCRIPTION] Act of the Parliament of Australia, currently registered as C2008A00011 [TYPE] Act of the Parliament of Australia>, <Governors (Emoluments, Allowances and Privileges) Amendment Act, 2008 [DESCRIPTION] Act of the Parliament of India [TYPE] Act of the Parliament of India>, <Higher Education Support Amendment (2008 Budget Measures) Act 2008 [DESCRIPTION] Act of the Parliament of Australia, currently registered as C2008A00043 [TYPE] Act of the Parliament of Australia>, <Higher Education Funding Amendment Act 1999 [DESCRIPTION] Act of the Parliament of Australia [TYPE] Act of the Parliament of Australia>, <Education Legislation Amendment Act 2008 [DESCRIPTION] Act of the Parliament of Australia, currently registered as C2010C00140 [TYPE] Act of the Parliament of Australia>, <NIL [DESCRIPTION] Not in list [TYPE] None>, <Unlawful Activities (Prevention) Amendment Act, 2008 [DESCRIPTION] Act of the Parliament of India [TYPE] Act of the Parliament of India>, <Higher Education Legislation Amendment Act 2004 [DESCRIPTION] Act of the Parliament of Australia, currently registered as C2004A01280 [TYPE] Act of the Parliament of Australia>, <Higher Education Funding Amendment Act 2001 [DESCRIPTION] Act of the Parliament of Australia, currently registered as C2004A00853 [TYPE] Act of the Parliament of Australia>, <Higher Education Legislation Amendment Act 2003 [DESCRIPTION] Act of the Parliament of Australia, currently registered as C2004A01172 [TYPE] Act of the Parliament of Australia>. What is the correct referent entity for the entity mention 'Higher Education Amendment Act, 2008' ? ### Response:"
try:
    model = AutoModel.from_pretrained(model_name, trust_remote_code=True)
    tokenizer = AutoTokenizer.from_pretrained(tokenizer_name)

    generation_config = {
        "max_new_tokens": 128,
        "do_sample": False,
        "temperature": 0.7,
        "top_p": 0.9,
        "repetition_penalty": 1.1,
        "pad_token_id": tokenizer.eos_token_id,
    }

    model_inputs = tokenizer([test_prompt])

    generated_ids = model.generate(
        **model_inputs, **generation_config
    )

    # Decode outputs
    decoded = tokenizer.batch_decode(
        generated_ids,
        skip_special_tokens=True,
        clean_up_tokenization_spaces=True,
    )

    print(decoded[0])

    print(
        f"Successfully loaded model: {model_name} and tokenizer: {tokenizer_name}")
except Exception as e:
    raise ValueError(f"Invalid model or tokenizer name: {e}")
